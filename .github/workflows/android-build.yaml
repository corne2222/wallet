name: Android Build

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:
  workflow_call:
    secrets:
      ANDROID_KEYSTORE_BASE64:
        required: false
      ORG_GRADLE_PROJECT_RELEASE_STORE_PASSWORD:
        required: false
      ORG_GRADLE_PROJECT_RELEASE_KEY_ALIAS:
        required: false
      ORG_GRADLE_PROJECT_RELEASE_KEY_PASSWORD:
        required: false

jobs:
  android-build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    secrets: inherit
    outputs:
      apk-path: ${{ steps.upload-apk.outputs.artifact-path }}
      apk-url: ${{ steps.upload-apk.outputs.artifact-url }}
      aab-path: ${{ steps.upload-aab.outputs.artifact-path }}
      aab-url: ${{ steps.upload-aab.outputs.artifact-url }}
      mapping-path: ${{ steps.upload-mapping.outputs.artifact-path }}
      mapping-url: ${{ steps.upload-mapping.outputs.artifact-url }}
      test-reports-path: ${{ steps.upload-test-reports.outputs.artifact-path }}
      test-reports-url: ${{ steps.upload-test-reports.outputs.artifact-url }}
    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: '17'

      - uses: android-actions/setup-android@v4
        with:
          sdk-version: '35'

      - uses: gradle/actions/setup-gradle@v5

      - name: Extract Version
        id: get-version
        run: |
          ANDROID_VERSION=$(grep -oP 'versionName = "\K[^"]+' composeApp/build.gradle.kts)
          PACKAGE_VERSION=$(grep -oP 'packageVersion = "\K[^"]+' composeApp/build.gradle.kts)
          echo "Android version: $ANDROID_VERSION"
          echo "Package version: $PACKAGE_VERSION"
          echo "android-version=$ANDROID_VERSION" >> $GITHUB_ENV
          echo "package-version=$PACKAGE_VERSION" >> $GITHUB_ENV

      - name: Decode Keystore
        run: |
          if [ -n "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" ]; then
            echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > composeApp/release.keystore
          fi

      - name: Export Signing Environment Variables
        run: |
          if [ -n "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" ]; then
            echo "ORG_GRADLE_PROJECT_RELEASE_STORE_PASSWORD=${{ secrets.ORG_GRADLE_PROJECT_RELEASE_STORE_PASSWORD }}" >> $GITHUB_ENV
            echo "ORG_GRADLE_PROJECT_RELEASE_KEY_ALIAS=${{ secrets.ORG_GRADLE_PROJECT_RELEASE_KEY_ALIAS }}" >> $GITHUB_ENV
            echo "ORG_GRADLE_PROJECT_RELEASE_KEY_PASSWORD=${{ secrets.ORG_GRADLE_PROJECT_RELEASE_KEY_PASSWORD }}" >> $GITHUB_ENV
          fi

      - name: Run Android Build and Tests
        run: |
          ./gradlew :composeApp:clean :composeApp:assembleDebug :composeApp:assembleRelease :composeApp:bundleRelease

      - name: Run Android Instrumented Tests
        if: always()
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 34
          target: google_apis
          arch: x86_64
          script: ./gradlew :composeApp:connectedDebugAndroidTest

      - name: Upload APK
        id: upload-apk
        uses: actions/upload-artifact@v5
        with:
          name: android-apk-${{ env.android-version }}
          path: composeApp/build/outputs/apk/release/*.apk
          retention-days: 30

      - name: Upload AAB
        id: upload-aab
        uses: actions/upload-artifact@v5
        with:
          name: android-aab-${{ env.android-version }}
          path: composeApp/build/outputs/bundle/release/*.aab
          retention-days: 30

      - name: Upload Mapping File
        id: upload-mapping
        uses: actions/upload-artifact@v5
        with:
          name: android-mapping-${{ env.android-version }}
          path: composeApp/build/outputs/mapping/release/mapping.txt
          retention-days: 30

      - name: Upload Test Reports
        id: upload-test-reports
        uses: actions/upload-artifact@v5
        with:
          name: android-test-reports-${{ env.android-version }}
          path: |
            composeApp/build/reports/tests/
            composeApp/build/test-results/
          retention-days: 30