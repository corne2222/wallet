name: Upstream Sync

on:
  schedule:
    - cron: '0 0 * * *'  # Daily at midnight UTC
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: |
          git remote add upstream "${{ secrets.UPSTREAM_REPO }}"

      - name: Fetch upstream main
        run: |
          git fetch upstream main

      - name: Check if merge is needed
        id: check_merge
        run: |
          # Compare local main with upstream/main
          LOCAL_HEAD=$(git rev-parse main)
          UPSTREAM_HEAD=$(git rev-parse upstream/main)
          if [ "$LOCAL_HEAD" = "$UPSTREAM_HEAD" ]; then
            echo "already_synced=true" >> $GITHUB_OUTPUT
          else
            echo "already_synced=false" >> $GITHUB_OUTPUT
          fi

      - name: Exit early if already synced
        if: steps.check_merge.outputs.already_synced == 'true'
        run: |
          echo "Repository is already synced with upstream."
          exit 0

      - name: Attempt merge
        id: merge
        run: |
          git merge upstream/main --no-commit --no-ff 2>&1 || {
            echo "merge_conflict=true" >> $GITHUB_OUTPUT
            exit 0
          }
          echo "merge_conflict=false" >> $GITHUB_OUTPUT

      - name: Get conflicted files
        if: steps.merge.outputs.merge_conflict == 'true'
        id: conflict_info
        run: |
          # Get the list of conflicted files
          CONFLICTS=$(git diff --name-only --diff-filter=U)
          echo "conflicts<<EOF" >> $GITHUB_OUTPUT
          echo "$CONFLICTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          # Abort the merge since we detected conflicts
          git merge --abort

      - name: Setup Java (for tests)
        if: steps.merge.outputs.merge_conflict == 'false'
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Setup Gradle
        if: steps.merge.outputs.merge_conflict == 'false'
        uses: gradle/actions/setup-gradle@v5

      - name: Run tests
        if: steps.merge.outputs.merge_conflict == 'false'
        run: ./gradlew allTests

      - name: Abort merge if tests fail
        if: failure() && steps.merge.outputs.merge_conflict == 'false'
        run: |
          git merge --abort

      - name: Commit merge
        if: steps.merge.outputs.merge_conflict == 'false' && success()
        run: |
          git commit -m "chore: sync with upstream main" --no-verify

      - name: Get merge summary
        if: steps.merge.outputs.merge_conflict == 'false' && success()
        id: summary
        run: |
          # Get the list of upstream commits
          COMMITS=$(git log main..upstream/main --oneline | wc -l)
          echo "commit_count=$COMMITS" >> $GITHUB_OUTPUT
          SUMMARY=$(git log main..upstream/main --oneline | head -20)
          echo "summary<<EOF" >> $GITHUB_OUTPUT
          echo "$SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create or update pull request (success)
        if: steps.merge.outputs.merge_conflict == 'false' && success()
        id: cpr_success
        uses: peter-evans/create-pull-request@v7
        with:
          commit-message: 'chore: sync with upstream main'
          title: 'chore: sync with upstream main'
          body: |
            ## Upstream Sync

            This PR syncs the latest changes from the upstream repository.

            ### Commits (${{ steps.summary.outputs.commit_count }}):
            ```
            ${{ steps.summary.outputs.summary }}
            ```

            Generated by [Upstream Sync Workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          branch: automation/upstream-sync
          delete-branch: true

      - name: Create pull request for conflicts
        if: steps.merge.outputs.merge_conflict == 'true'
        id: cpr_conflict
        uses: peter-evans/create-pull-request@v7
        with:
          commit-message: 'chore: sync with upstream main (conflicts detected)'
          title: 'chore: sync with upstream main (conflicts detected - needs manual rebase)'
          body: |
            ## Upstream Sync - Merge Conflicts Detected

            This PR attempted to sync changes from the upstream repository, but merge conflicts were detected.

            ### Conflicted Files:
            ```
            ${{ steps.conflict_info.outputs.conflicts }}
            ```

            **This PR requires manual intervention to resolve conflicts.**

            Generated by [Upstream Sync Workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          branch: automation/upstream-sync
          delete-branch: false
          labels: 'needs-manual-rebase'

      - name: Add conflict comment
        if: steps.merge.outputs.merge_conflict == 'true' && steps.cpr_conflict.outputs.pull-request-number
        uses: actions/github-script@v7
        with:
          script: |
            const conflicts = `${{ steps.conflict_info.outputs.conflicts }}`;
            
            github.rest.issues.createComment({
              issue_number: ${{ steps.cpr_conflict.outputs.pull-request-number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ⚠️ Merge Conflicts Detected\n\nThe following files have conflicts:\n\`\`\`\n${conflicts}\n\`\`\`\n\nPlease resolve these conflicts manually and push to the \`automation/upstream-sync\` branch.`
            });

      - name: Fail if conflicts detected
        if: steps.merge.outputs.merge_conflict == 'true'
        run: |
          echo "Merge conflicts detected. Manual intervention required."
          exit 1

      - name: Enable auto-merge if configured
        if: steps.merge.outputs.merge_conflict == 'false' && success() && vars.AUTO_SYNC_AUTOMERGE == 'true' && steps.cpr_success.outputs.pull-request-number
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          pull-request-number: ${{ steps.cpr_success.outputs.pull-request-number }}
          merge-method: squash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
